# セットアップガイド 🚀

NFCキッズポイントシステムを導入するための詳細手順を説明します。

## 📋 導入前の準備

### 必要なもの
- [ ] Googleアカウント（Gmail）
- [ ] iPhone（iOS 13以降、NFC対応）
- [ ] NFCタグ（NTAG213推奨、子供の人数分）
- [ ] パソコンまたはスマートフォン（ブラウザ利用）

### 推奨NFCタグ
| 型番 | 容量 | 価格目安 | 特徴 |
|------|------|---------|------|
| NTAG213 | 180 bytes | ¥100-200/枚 | 基本利用に最適 |
| NTAG215 | 924 bytes | ¥150-250/枚 | 将来拡張にも対応 |
| NTAG216 | 924 bytes | ¥200-300/枚 | 高耐久性 |

## 🏗️ セットアップ手順

### ステップ1: Google スプレッドシートの準備

#### 1.1 新規スプレッドシート作成
1. [Google スプレッドシート](https://sheets.google.com)にアクセス
2. 「空白のスプレッドシート」をクリック
3. ファイル名を「NFCキッズポイント」に変更

#### 1.2 シートの整理
- デフォルトの「Sheet1」は削除してOK
- 子供の分のシートは後で自動作成されます

### ステップ2: Google Apps Script設定

#### 2.1 Apps Scriptエディタを開く
1. スプレッドシート上で「拡張機能」メニューをクリック
2. 「Apps Script」を選択
3. 新しいタブでエディタが開きます

#### 2.2 コードの配置
1. デフォルトの`Code.gs`の内容を全て削除
2. [scripts/Code-v2.gs](../scripts/Code-v2.gs)の内容をコピー&ペースト（最新版）
3. `Ctrl+S`（または`Cmd+S`）で保存

**重要**: Code-v2.gsは改良版UIと最適化されたパフォーマンスを含みます

#### 2.3 プロジェクト名の設定
1. 左上の「無題のプロジェクト」をクリック
2. 「NFCキッズポイントシステム」に名前を変更

### ステップ3: Webアプリとして公開

#### 3.1 デプロイの開始
1. 右上の「デプロイ」ボタンをクリック
2. 「新しいデプロイ」を選択

#### 3.2 デプロイ設定
```
タイプ: ウェブアプリ
説明: NFCキッズポイントシステム v1.0
実行ユーザー: 自分
アクセスできるユーザー: 全員
```

#### 3.3 認証と公開
1. 「デプロイ」ボタンをクリック
2. 権限の承認画面が表示されたら「許可」をクリック
3. **重要**: WebアプリのURLをコピーして保存
   ```
   例: https://script.google.com/macros/s/ABC123.../exec
   ```

### ステップ4: iPhone ショートカットの設定

#### 4.1 基本ショートカットの作成

**太郎くん用のショートカット例:**

1. ショートカットアプリを開く
2. 右上の「+」をタップして新規作成
3. 「アクションを追加」をタップ

#### 4.2 アクション設定

**アクション1: メニューから選択**
```
アクション: メニューから選択
プロンプト: ポイントをたくさん取りますか？
選択肢: はい, いいえ
```

**アクション2: リストから選択（はいの場合）**
```
アクション: リストから選択
プロンプト: ポイント数を選択してください
選択肢: 1, 2, 3, 5, 10
変数: selectedPoints に設定
```
※「いいえ」の場合は1ポイントを自動設定

**アクション3: 辞書を作成**
```
アクション: 辞書
キー: 
  - nfcId: "nfc-taro-001"
  - tagName: "太郎" 
  - points: [変数:selectedPoints または 1]
変数: requestData に設定
```

**アクション4: Webリクエスト**
```
アクション: Webの内容を取得
URL: [手順3.3で取得したWebアプリURL]
メソッド: POST
ヘッダ:
  Content-Type: application/json
本文: [変数:requestData]
```

**アクション5: フィードバック**
```
アクション: デバイスを振動
振動の種類: 通知

アクション: サウンドを再生
サウンド: 完了音
```

#### 4.3 ショートカット名の設定
1. ショートカット設定画面の上部をタップ
2. 名前を「太郎のポイント記録」に設定
3. アイコンと色をお好みで設定

#### 4.4 NFCトリガーの設定
1. ショートカット設定画面の「オートメーション」をタップ
2. 「個人用オートメーション」→「作成」
3. 「NFC」を選択
4. NFCタグをiPhoneでスキャン
5. 作成したショートカットを選択
6. 「実行前に確認」をOFFに設定

### ステップ5: 子供別のショートカット作成

各お子さん用に個別のショートカットを作成：

#### 花子ちゃん用
```json
{"nfcId":"nfc-hanako-001","tagName":"花子","points":1}
```

#### 次郎くん用
```json
{"nfcId":"nfc-jiro-001","tagName":"次郎","points":1}
```

### ステップ6: 動作テスト

#### 6.1 手動テスト
1. 作成したショートカットを手動で実行
2. スプレッドシートに新しいシートが作成されることを確認
3. データが正しく記録されていることを確認

#### 6.2 NFCテスト
1. NFCタグをiPhoneでスキャン
2. ショートカットが自動実行されることを確認
3. 通知が表示されることを確認

#### 6.3 ダッシュボードテスト
1. WebアプリのURLにブラウザでアクセス
2. `?action=dashboard`パラメータを追加
   ```
   https://script.google.com/.../exec?action=dashboard
   ```
3. ダッシュボードが表示されることを確認

## 🔧 詳細設定

### ポイント制度のカスタマイズ

#### 活動別ポイント設定
異なる活動に異なるポイントを設定する場合：

**宿題完了用（5ポイント）:**
```json
{"nfcId":"nfc-taro-homework","tagName":"太郎","points":5}
```

**お手伝い用（3ポイント）:**
```json
{"nfcId":"nfc-taro-help","tagName":"太郎","points":3}
```

### 複数NFCタグの管理

| 子供 | 基本活動タグ | 宿題タグ | お手伝いタグ |
|------|------------|---------|------------|
| 太郎 | nfc-taro-001 (1pt) | nfc-taro-hw (5pt) | nfc-taro-help (3pt) |
| 花子 | nfc-hanako-001 (1pt) | nfc-hanako-hw (5pt) | nfc-hanako-help (3pt) |

### セキュリティ設定の調整

#### Webアプリのアクセス制限
より厳格なセキュリティが必要な場合：
1. Apps Scriptエディタでデプロイ設定を変更
2. 「アクセスできるユーザー」を「Googleアカウントでログインしているユーザー」に変更
3. 再デプロイを実行

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### 問題1: NFCタグが反応しない
**解決策:**
- [ ] iPhoneの設定 → プライバシーとセキュリティ → NFC が有効か確認
- [ ] NFCタグをiPhone上部（カメラ付近）に正しく位置付け
- [ ] 厚いケースや金属製ケースが干渉していないか確認
- [ ] NFCタグが故障していないか別のデバイスでテスト

#### 問題2: ショートカットが実行されない
**解決策:**
- [ ] ショートカットのオートメーション設定を確認
- [ ] 「実行前に確認」がOFFになっているか確認
- [ ] ショートカットの権限設定を確認
- [ ] 手動実行でエラーが出ないかテスト

#### 問題3: データがスプレッドシートに記録されない
**解決策:**
- [ ] WebアプリのURLが正しく設定されているか確認
- [ ] Apps Scriptの実行権限を確認
- [ ] JSONフォーマットが正しいか確認
- [ ] インターネット接続を確認

#### 問題4: ダッシュボードが表示されない
**解決策:**
- [ ] WebアプリのURLに`?action=dashboard`が付いているか確認
- [ ] ブラウザのJavaScriptが有効になっているか確認
- [ ] Chart.js のCDN読み込みエラーがないか確認
- [ ] ブラウザキャッシュをクリアして再試行

### エラーコードと対処法

#### 403 Forbidden
**原因**: Apps Scriptの権限不足  
**対処**: Webアプリの公開設定を「全員」に変更

#### 500 Internal Server Error
**原因**: スクリプトのエラー  
**対処**: Apps Script エディタでログを確認し、エラー箇所を修正

#### Network Error
**原因**: ネットワーク接続の問題  
**対処**: Wi-Fi/モバイルデータの接続を確認

## 📊 カスタマイズ例

### 1. 時間制限付きポイント

**平日のみポイント付与するショートカット:**
```javascript
// ショートカット内の条件分岐アクション
現在の日付を取得 → 曜日を判定 → 平日の場合のみWebリクエスト実行
```

### 2. ボーナスポイント制度

**週末はポイント2倍:**
```json
{"nfcId":"nfc-taro-weekend","tagName":"太郎","points":2}
```

### 3. 目標達成ボーナス

**特別な成果には高ポイント:**
```json
{"nfcId":"nfc-taro-achievement","tagName":"太郎","points":10}
```

## 📅 運用開始後の管理

### 日常の運用
- [ ] 毎日のポイント記録状況をダッシュボードで確認
- [ ] 子供たちの活動パターンを統計で分析
- [ ] NFCタグの動作状況を定期チェック

### 週次メンテナンス
- [ ] 各子供のポイント獲得状況をレビュー
- [ ] 異常なポイント増加がないかチェック
- [ ] ダッシュボードの表示速度確認

### 月次レポート
- [ ] 各子供の成長記録を統計から作成
- [ ] システムの利用状況分析
- [ ] 必要に応じてポイント制度の調整

## 🎯 成功のためのヒント

### 1. 段階的な導入
1. **第1週**: 基本的な習慣（歯磨き、着替え）のみ
2. **第2週**: 宿題・勉強を追加
3. **第3週**: お手伝いを追加
4. **第4週**: 全機能での本格運用

### 2. ポイント制度の設計
- 簡単な習慣には少ないポイント（1-2pt）
- 努力の必要な活動には多めのポイント（3-5pt）
- 特別な成果には大きなボーナス（10pt+）

### 3. 子供のモチベーション維持
- ダッシュボードを一緒に見て成長を実感
- 週間・月間の目標設定
- ポイントの使い道を事前に相談

## 📞 サポート

設定や運用でご質問がある場合：
1. [トラブルシューティング](#-トラブルシューティング)を確認
2. [システム構成図](system-architecture.md)で全体像を把握
3. [iPhoneショートカット設定ガイド](iphone-shortcut-setup.md)を再確認
4. GitHubのIssueで質問投稿

---

**設定完了後**: 家族全員でダッシュボードを確認し、楽しいポイント生活をスタートしてください！